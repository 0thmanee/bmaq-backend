import { FastifyInstance, FastifyRequest, FastifyReply } from 'fastify';
import jwt from 'jsonwebtoken';

const JWT_SECRET = process.env.JWT_SECRET || 'your-super-secret-jwt-key-change-this-in-production';

// Authentication middleware
async function authenticateAdmin(request: FastifyRequest, reply: FastifyReply) {
  try {
    const authHeader = request.headers.authorization;
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return reply.code(401).send({
        success: false,
        message: 'No token provided'
      });
    }

    const token = authHeader.split(' ')[1];
    const decoded = jwt.verify(token, JWT_SECRET) as any;
    
    // Check if user is admin
    if (decoded.role !== 'ADMIN') {
      return reply.code(403).send({
        success: false,
        message: 'Admin access required'
      });
    }

    // Add user info to request
    (request as any).user = decoded;
  } catch (error) {
    return reply.code(401).send({
      success: false,
      message: 'Invalid token'
    });
  }
}

// User authentication middleware
async function authenticateUser(request: FastifyRequest, reply: FastifyReply) {
  try {
    const authHeader = request.headers.authorization;
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return reply.code(401).send({
        success: false,
        message: 'No token provided'
      });
    }

    const token = authHeader.split(' ')[1];
    const decoded = jwt.verify(token, JWT_SECRET) as any;
    
    // Add user info to request
    (request as any).user = decoded;
  } catch (error) {
    return reply.code(401).send({
      success: false,
      message: 'Invalid token'
    });
  }
}

/**
 * Dashboard routes for admin statistics
 */
module.exports = async function (fastify: FastifyInstance) {
  
  // Get admin dashboard overview statistics
  fastify.get('/dashboard/overview', {
    schema: {
      tags: ['Dashboard'],
      summary: 'Get admin dashboard overview statistics',
      description: 'Get aggregated statistics for admin dashboard',
      headers: {
        type: 'object',
        required: ['authorization'],
        properties: {
          authorization: { type: 'string' }
        }
      },
      response: {
        200: {
          type: 'object',
          properties: {
            success: { type: 'boolean' },
            data: {
              type: 'object',
              properties: {
                totalStartups: { type: 'number' },
                activeFounders: { type: 'number' },
                totalBudgetAllocated: { type: 'number' },
                totalBudgetUsed: { type: 'number' },
                budgetUsagePercentage: { type: 'number' },
                pendingRequests: { type: 'number' },
                upcomingEvents: { type: 'number' },
                resourcesUploaded: { type: 'number' },
                questionnairesCompleted: { type: 'number' }
              }
            }
          }
        }
      }
    },
    preHandler: authenticateAdmin
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    try {
      // Get total startups
      const totalStartups = await fastify.prisma.startup.count();

      // Get active founders (users with approved status)
      const activeFounders = await fastify.prisma.user.count({
        where: {
          role: 'STARTUP',
          status: 'APPROVED'
        }
      });

      // Get budget statistics
      const budgetStats = await fastify.prisma.startupBudget.aggregate({
        _sum: {
          total_budget: true,
          used_budget: true
        }
      });

      const totalBudgetAllocated = Number(budgetStats._sum.total_budget || 0);
      const totalBudgetUsed = Number(budgetStats._sum.used_budget || 0);
      const budgetUsagePercentage = totalBudgetAllocated > 0 
        ? Math.round((totalBudgetUsed / totalBudgetAllocated) * 100) 
        : 0;

      // Get pending budget requests
      const pendingRequests = await fastify.prisma.budgetRequest.count({
        where: {
          status: 'PENDING'
        }
      });

      // Get upcoming events (events with future dates)
      const upcomingEvents = await fastify.prisma.event.count({
        where: {
          date: {
            gte: new Date()
          },
          status: {
            in: ['UPCOMING', 'DRAFT']
          }
        }
      });

      // Get total resources uploaded
      const resourcesUploaded = await fastify.prisma.resource.count();

      // Get completed questionnaires (suivi responses)
      const questionnairesCompleted = await fastify.prisma.suiviResponse.count();

      return reply.send({
        success: true,
        data: {
          totalStartups,
          activeFounders,
          totalBudgetAllocated,
          totalBudgetUsed,
          budgetUsagePercentage,
          pendingRequests,
          upcomingEvents,
          resourcesUploaded,
          questionnairesCompleted
        }
      });

    } catch (error) {
      fastify.log.error('Dashboard overview error:', error);
      return reply.code(500).send({
        success: false,
        message: 'Internal server error'
      });
    }
  });

  // Get recent activity for dashboard
  fastify.get('/dashboard/activity', {
    schema: {
      tags: ['Dashboard'],
      summary: 'Get recent activity for admin dashboard',
      description: 'Get recent activities across the platform',
      headers: {
        type: 'object',
        required: ['authorization'],
        properties: {
          authorization: { type: 'string' }
        }
      },
      querystring: {
        type: 'object',
        properties: {
          limit: { type: 'number', default: 10 }
        }
      },
      response: {
        200: {
          type: 'object',
          properties: {
            success: { type: 'boolean' },
            data: {
              type: 'array',
              items: {
                type: 'object',
                properties: {
                  id: { type: 'string' },
                  type: { type: 'string' },
                  user: { type: 'string' },
                  action: { type: 'string' },
                  amount: { type: 'number' },
                  details: { type: 'string' },
                  time: { type: 'string' },
                  status: { type: 'string' }
                }
              }
            }
          }
        }
      }
    },
    preHandler: authenticateAdmin
  }, async (request: FastifyRequest<{ Querystring: { limit?: number } }>, reply: FastifyReply) => {
    try {
      const limit = request.query.limit || 10;
      const activities: any[] = [];

      // Get recent budget requests
      const recentRequests = await fastify.prisma.budgetRequest.findMany({
        take: Math.floor(limit / 2),
        orderBy: { created_at: 'desc' },
        include: {
          startup: { select: { company_name: true } },
          user: { select: { name: true } }
        }
      });

      recentRequests.forEach(request => {
        activities.push({
          id: `request-${request.id}`,
          type: 'request',
          user: request.startup.company_name,
          action: 'submitted budget request',
          amount: Number(request.amount),
          details: request.category,
          time: formatTimeAgo(request.created_at),
          status: request.status.toLowerCase()
        });
      });

      // Get recent events
      const recentEvents = await fastify.prisma.event.findMany({
        take: Math.floor(limit / 4),
        orderBy: { created_at: 'desc' }
      });

      recentEvents.forEach(event => {
        activities.push({
          id: `event-${event.id}`,
          type: 'event',
          user: 'Admin',
          action: 'created new event',
          details: event.title,
          time: formatTimeAgo(event.created_at),
          status: 'active'
        });
      });

      // Get recent resources
      const recentResources = await fastify.prisma.resource.findMany({
        take: Math.floor(limit / 4),
        orderBy: { created_at: 'desc' },
        include: {
          uploader: { select: { name: true } }
        }
      });

      recentResources.forEach(resource => {
        activities.push({
          id: `resource-${resource.id}`,
          type: 'resource',
          user: resource.uploader.name || 'Admin',
          action: 'uploaded new resource',
          details: resource.title,
          time: formatTimeAgo(resource.created_at),
          status: 'active'
        });
      });

      // Sort all activities by time (most recent first)
      activities.sort((a, b) => {
        // Convert time ago to sortable format (this is simplified)
        return b.id.localeCompare(a.id);
      });

      return reply.send({
        success: true,
        data: activities.slice(0, limit)
      });

    } catch (error) {
      fastify.log.error('Dashboard activity error:', error);
      return reply.code(500).send({
        success: false,
        message: 'Internal server error'
      });
    }
  });

  // Get system health status
  fastify.get('/dashboard/health', {
    schema: {
      tags: ['Dashboard'],
      summary: 'Get system health status',
      description: 'Get system health indicators for admin dashboard',
      headers: {
        type: 'object',
        required: ['authorization'],
        properties: {
          authorization: { type: 'string' }
        }
      },
      response: {
        200: {
          type: 'object',
          properties: {
            success: { type: 'boolean' },
            data: {
              type: 'object',
              properties: {
                database: {
                  type: 'object',
                  properties: {
                    status: { type: 'string' },
                    responseTime: { type: 'number' }
                  }
                },
                api: {
                  type: 'object',
                  properties: {
                    status: { type: 'string' },
                    uptime: { type: 'number' }
                  }
                },
                storage: {
                  type: 'object',
                  properties: {
                    status: { type: 'string' },
                    usage: { type: 'number' }
                  }
                }
              }
            }
          }
        }
      }
    },
    preHandler: authenticateAdmin
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    try {
      // Test database connection
      const dbStart = Date.now();
      await fastify.prisma.$queryRaw`SELECT 1`;
      const dbResponseTime = Date.now() - dbStart;

      // Mock storage usage (in production, you'd get this from your storage provider)
      const storageUsage = Math.floor(Math.random() * 30) + 60; // 60-90% usage

      return reply.send({
        success: true,
        data: {
          database: {
            status: 'healthy',
            responseTime: dbResponseTime
          },
          api: {
            status: 'healthy',
            uptime: process.uptime()
          },
          storage: {
            status: storageUsage > 85 ? 'warning' : 'healthy',
            usage: storageUsage
          }
        }
      });

    } catch (error) {
      fastify.log.error('Dashboard health error:', error);
      return reply.code(500).send({
        success: false,
        message: 'Internal server error'
      });
    }
  });

  // Get user dashboard data
  fastify.get('/dashboard/user', {
    schema: {
      tags: ['Dashboard'],
      summary: 'Get user dashboard data',
      description: 'Get dashboard data for authenticated startup user',
      headers: {
        type: 'object',
        required: ['authorization'],
        properties: {
          authorization: { type: 'string' }
        }
      },
      response: {
        200: {
          type: 'object',
          properties: {
            success: { type: 'boolean' },
            data: {
              type: 'object',
              properties: {
                budget: {
                  type: 'object',
                  properties: {
                    total: { type: 'number' },
                    used: { type: 'number' },
                    remaining: { type: 'number' },
                    categories: {
                      type: 'array',
                      items: {
                        type: 'object',
                        properties: {
                          name: { type: 'string' },
                          budget: { type: 'number' },
                          used: { type: 'number' },
                          color: { type: 'string' },
                          percentage: { type: 'number' }
                        }
                      }
                    }
                  }
                },
                recentRequests: {
                  type: 'array',
                  items: {
                    type: 'object',
                    properties: {
                      id: { type: 'number' },
                      title: { type: 'string' },
                      date: { type: 'string' },
                      status: { type: 'string' },
                      category: { type: 'string' },
                      amount: { type: 'string' }
                    }
                  }
                },
                upcomingEvents: {
                  type: 'array',
                  items: {
                    type: 'object',
                    properties: {
                      id: { type: 'number' },
                      title: { type: 'string' },
                      date: { type: 'string' },
                      time: { type: 'string' },
                      type: { type: 'string' },
                      status: { type: 'string' },
                      participants: { type: 'number' },
                      maxParticipants: { type: 'number' }
                    }
                  }
                },
                recentResources: {
                  type: 'array',
                  items: {
                    type: 'object',
                    properties: {
                      id: { type: 'number' },
                      title: { type: 'string' },
                      category: { type: 'string' },
                      type: { type: 'string' },
                      size: { type: 'string' },
                      downloads: { type: 'number' }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    preHandler: authenticateUser
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    try {
      const user = (request as any).user;
      
      // Get user's startup
      const startup = await fastify.prisma.startup.findFirst({
        where: { user_id: user.id },
        include: {
          user: true,
          budget: {
            include: {
              categories: true
            }
          }
        }
      });

      if (!startup) {
        return reply.code(404).send({
          success: false,
          message: 'Startup not found'
        });
      }

      // Get budget data
      const budget = startup.budget;
      const categories = budget?.categories || [];
      
      const budgetData = {
        total: Number(budget?.total_budget || 0),
        used: Number(budget?.used_budget || 0),
        remaining: Number(budget?.total_budget || 0) - Number(budget?.used_budget || 0),
        categories: categories.map(cat => ({
          name: cat.name,
          budget: Number(cat.allocated_amount),
          used: Number(cat.used_amount),
          color: getCategoryColor(cat.name),
          percentage: Number(cat.allocated_amount) > 0 ? Math.round((Number(cat.used_amount) / Number(cat.allocated_amount)) * 100) : 0
        }))
      };

      // Get recent requests
      const recentRequests = await fastify.prisma.budgetRequest.findMany({
        where: { 
          startup_id: startup.id 
        },
        orderBy: { created_at: 'desc' },
        take: 3
      });

      // Get upcoming events
      const upcomingEvents = await fastify.prisma.event.findMany({
        where: {
          date: {
            gte: new Date()
          },
          status: {
            in: ['UPCOMING', 'OPEN']
          }
        },
        orderBy: { date: 'asc' },
        take: 4
      });

      // Get recent resources
      const recentResources = await fastify.prisma.resource.findMany({
        where: {
          is_public: true
        },
        orderBy: { created_at: 'desc' },
        take: 3
      });

      return reply.send({
        success: true,
        data: {
          budget: budgetData,
          recentRequests: recentRequests.map(req => ({
            id: req.id,
            title: req.description,
            date: req.created_at.toISOString().split('T')[0],
            status: req.status,
            category: req.category,
            amount: `$${Number(req.amount).toLocaleString()}`
          })),
          upcomingEvents: upcomingEvents.map(event => ({
            id: event.id,
            title: event.title,
            date: event.date.toISOString().split('T')[0],
            time: event.time,
            type: event.type,
            status: event.status,
            participants: event.current_attendees || 0,
            maxParticipants: event.max_attendees || 0
          })),
          recentResources: recentResources.map(resource => ({
            id: resource.id,
            title: resource.title,
            category: resource.category,
            type: resource.type,
            size: resource.file_size || 'N/A',
            downloads: resource.downloads || 0
          }))
        }
      });

    } catch (error) {
      fastify.log.error('User dashboard error:', error);
      return reply.code(500).send({
        success: false,
        message: 'Internal server error'
      });
    }
  });

  // Get user events
  fastify.get('/dashboard/user/events', {
    schema: {
      tags: ['Dashboard'],
      summary: 'Get user events',
      description: 'Get events for authenticated startup user',
      headers: {
        type: 'object',
        required: ['authorization'],
        properties: {
          authorization: { type: 'string' }
        }
      },
      response: {
        200: {
          type: 'object',
          properties: {
            success: { type: 'boolean' },
            data: {
              type: 'array',
              items: {
                type: 'object',
                properties: {
                  id: { type: 'number' },
                  title: { type: 'string' },
                  date: { type: 'string' },
                  time: { type: 'string' },
                  type: { type: 'string' },
                  status: { type: 'string' },
                  participants: { type: 'number' },
                  maxParticipants: { type: 'number' }
                }
              }
            }
          }
        }
      }
    },
    preHandler: authenticateUser
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    try {
      const upcomingEvents = await fastify.prisma.event.findMany({
        where: {
          date: {
            gte: new Date()
          },
          OR: [
            { status: 'UPCOMING' },
            { status: 'OPEN' }
          ]
        },
        orderBy: { date: 'asc' },
        take: 10
      });

      return reply.send({
        success: true,
        data: upcomingEvents.map(event => ({
          id: event.id,
          title: event.title,
          date: event.date.toISOString().split('T')[0],
          time: event.time,
          type: event.type,
          status: event.status,
          participants: event.current_attendees || 0,
          maxParticipants: event.max_attendees || 0
        }))
      });

    } catch (error) {
      fastify.log.error('User events error:', error);
      return reply.code(500).send({
        success: false,
        message: 'Internal server error'
      });
    }
  });

  // Get user resources
  fastify.get('/dashboard/user/resources', {
    schema: {
      tags: ['Dashboard'],
      summary: 'Get user resources',
      description: 'Get resources for authenticated startup user',
      headers: {
        type: 'object',
        required: ['authorization'],
        properties: {
          authorization: { type: 'string' }
        }
      },
      response: {
        200: {
          type: 'object',
          properties: {
            success: { type: 'boolean' },
            data: {
              type: 'array',
              items: {
                type: 'object',
                properties: {
                  id: { type: 'number' },
                  title: { type: 'string' },
                  category: { type: 'string' },
                  type: { type: 'string' },
                  size: { type: 'string' },
                  downloads: { type: 'number' }
                }
              }
            }
          }
        }
      }
    },
    preHandler: authenticateUser
  }, async (request: FastifyRequest, reply: FastifyReply) => {
    try {
      const resources = await fastify.prisma.resource.findMany({
        where: {
          is_public: true
        },
        orderBy: { created_at: 'desc' },
        take: 10
      });

      return reply.send({
        success: true,
        data: resources.map(resource => ({
          id: resource.id,
          title: resource.title,
          category: resource.category,
          type: resource.type,
          size: resource.file_size || 'N/A',
          downloads: resource.downloads || 0
        }))
      });

    } catch (error) {
      fastify.log.error('User resources error:', error);
      return reply.code(500).send({
        success: false,
        message: 'Internal server error'
      });
    }
  });
};

// Helper function to format time ago
function formatTimeAgo(date: Date): string {
  const now = new Date();
  const diffInMs = now.getTime() - date.getTime();
  const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
  const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
  const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));

  if (diffInMinutes < 1) return 'Just now';
  if (diffInMinutes < 60) return `${diffInMinutes} minute${diffInMinutes > 1 ? 's' : ''} ago`;
  if (diffInHours < 24) return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;
  return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;
}

// Helper function to get category colors
function getCategoryColor(category: string): string {
  const colors: { [key: string]: string } = {
    'Cloud': '#94182C',
    'Marketing': '#dc2626',
    'IT': '#7c2d12',
    'Expos': '#991b1b',
    'Events': '#991b1b',
    'Freelances': '#b91c1c',
    'Training': '#059669',
    'Infrastructure': '#0d9488',
    'Tools': '#0891b2',
    'Other': '#6b7280'
  };
  return colors[category] || '#6b7280';
}

// Dummy function to get category color (replace with real implementation)
function getCategoryColor(category: string): string {
  const colors = {
    'Marketing': '#FF6384',
    'Development': '#36A2EB',
    'Design': '#FFCE56',
    'Finance': '#4BC0C0',
    'Legal': '#9966FF',
    'Operations': '#FF9F40'
  };
  return colors[category] || '#CCCCCC';
}